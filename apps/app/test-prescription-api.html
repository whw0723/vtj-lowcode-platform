<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤„æ–¹æ¥å£æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .test-item { 
            border: 1px solid #ddd; 
            margin: 10px 0; 
            padding: 15px; 
            border-radius: 5px; 
        }
        .test-item h3 { margin-top: 0; }
        button { 
            margin: 5px; 
            padding: 10px 15px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        button:hover { background-color: #0056b3; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; max-height: 300px; overflow-y: auto; }
        .info { background-color: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ” å¤„æ–¹æ¥å£è¯Šæ–­å·¥å…·</h1>
    
    <div class="info">
        <h3>å½“å‰é…ç½®ä¿¡æ¯ï¼š</h3>
                 <p><strong>ä»£ç†é…ç½®ï¼š</strong> /Manage â†’ http://192.168.80.79:8000</p>
        <p><strong>ç›®æ ‡æ¥å£ï¼š</strong> /Manage/PreScription/GetMyPreScriptionList</p>
        <p><strong>é—®é¢˜ï¼š</strong> è¯·æ±‚å‘å‘ localhost:9527 è€Œä¸æ˜¯ä»£ç†æœåŠ¡å™¨</p>
    </div>
    
    <div>
        <button onclick="testProxyConnection()">1. æµ‹è¯•ä»£ç†è¿æ¥</button>
        <button onclick="testKnownWorkingAPI()">2. æµ‹è¯•å·²çŸ¥å¯ç”¨æ¥å£</button>
        <button onclick="testPrescriptionPaths()">3. æµ‹è¯•å¤„æ–¹æ¥å£è·¯å¾„</button>
        <button onclick="testDirectConnection()">4. æµ‹è¯•ç›´è¿æœåŠ¡å™¨</button>
        <button onclick="runAllTests()">ğŸš€ è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
    </div>
    
    <div id="results"></div>

    <script>
        // é…ç½®axiosé»˜è®¤è®¾ç½®
        axios.defaults.withCredentials = true;
        
        // æ·»åŠ æ‹¦æˆªå™¨æ¥æŸ¥çœ‹å®é™…è¯·æ±‚çš„URL
        axios.interceptors.request.use(request => {
            console.log('ğŸš€ å‘é€è¯·æ±‚:', request.method.toUpperCase(), request.url);
            console.log('ğŸ“‹ è¯·æ±‚å¤´:', request.headers);
            if (request.data) {
                console.log('ğŸ“ è¯·æ±‚æ•°æ®:', request.data);
            }
            return request;
        });

        axios.interceptors.response.use(
            response => {
                console.log('âœ… å“åº”æˆåŠŸ:', response.status, response.statusText);
                console.log('ğŸ“Š å“åº”æ•°æ®:', response.data);
                return response;
            },
            error => {
                console.log('âŒ å“åº”é”™è¯¯:', error.response?.status, error.message);
                if (error.response) {
                    console.log('ğŸ“Š é”™è¯¯å“åº”:', error.response.data);
                }
                return Promise.reject(error);
            }
        );

        // å·²çŸ¥å¯ç”¨çš„æ¥å£
        const knownWorkingAPIs = [
            '/Manage/ModuleType/GetModelTypeByPage',
            '/Manage/ModuleType/GetModuleTypeSelectList',
            '/Manage/PreScription/GetExpressTypeDataByCache'
        ];

        // å¯èƒ½çš„å¤„æ–¹æ¥å£è·¯å¾„
        const prescriptionPaths = [
            '/Manage/PreScription/GetMyPreScriptionList',
            '/Manage/Prescription/GetMyPreScriptionList',
            '/Manage/PreScription/GetPreScriptionList',
            '/Manage/Prescription/GetPreScriptionList',
            '/Manage/PreScription/GetList',
            '/Manage/Prescription/GetList'
        ];

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            let className = type;
            let icon = '';
            
            switch(type) {
                case 'success': icon = 'âœ…'; break;
                case 'error': icon = 'âŒ'; break;
                case 'warning': icon = 'âš ï¸'; break;
                case 'info': icon = 'â„¹ï¸'; break;
            }
            
            resultsDiv.innerHTML += `<div class="${className}">[${timestamp}] ${icon} ${message}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // 1. æµ‹è¯•ä»£ç†è¿æ¥
        async function testProxyConnection() {
            clearResults();
            log('å¼€å§‹æµ‹è¯•ä»£ç†è¿æ¥...', 'info');
            
            try {
                // æµ‹è¯•ä¸€ä¸ªç®€å•çš„æ¥å£æ¥æ£€æŸ¥ä»£ç†æ˜¯å¦å·¥ä½œ
                const response = await axios.post('/Manage/ModuleType/GetModuleTypeSelectList', '', {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        'Accept': 'application/json, text/javascript, */*; q=0.01',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    timeout: 10000
                });
                
                log('ä»£ç†è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
                log(`å“åº”çŠ¶æ€: ${response.status}`, 'success');
                log(`å“åº”æ•°æ®: ${JSON.stringify(response.data).substring(0, 200)}...`, 'info');
                
                return true;
            } catch (error) {
                log(`ä»£ç†è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                log(`é”™è¯¯è¯¦æƒ…: ${error.response?.status} - ${error.response?.statusText}`, 'error');
                
                if (error.message.includes('localhost:9527')) {
                    log('âš ï¸ æ£€æµ‹åˆ°è¯·æ±‚å‘å‘localhost:9527ï¼Œä»£ç†é…ç½®å¯èƒ½æœªç”Ÿæ•ˆï¼', 'warning');
                    log('è§£å†³æ–¹æ¡ˆï¼š', 'info');
                    log('1. æ£€æŸ¥å¼€å‘æœåŠ¡å™¨æ˜¯å¦æ­£ç¡®åŠ è½½äº†proxy.config.ts', 'info');
                    log('2. é‡å¯å¼€å‘æœåŠ¡å™¨', 'info');
                                         log('3. ç¡®è®¤ä»£ç†æœåŠ¡å™¨192.168.80.79:8000æ˜¯å¦å¯è®¿é—®', 'info');
                }
                
                return false;
            }
        }

        // 2. æµ‹è¯•å·²çŸ¥å¯ç”¨æ¥å£
        async function testKnownWorkingAPI() {
            clearResults();
            log('æµ‹è¯•å·²çŸ¥å¯ç”¨æ¥å£...', 'info');
            
            for (const apiPath of knownWorkingAPIs) {
                try {
                    log(`æµ‹è¯•æ¥å£: ${apiPath}`, 'info');
                    
                    let requestData = '';
                    if (apiPath.includes('GetModelTypeByPage')) {
                        const params = new URLSearchParams();
                        params.append('page', '1');
                        params.append('limit', '5');
                        requestData = params;
                    }
                    
                    const response = await axios.post(apiPath, requestData, {
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                            'Accept': 'application/json, text/javascript, */*; q=0.01',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        timeout: 10000
                    });
                    
                    log(`âœ… ${apiPath} - æˆåŠŸ (${response.status})`, 'success');
                    
                    if (response.data && response.data.code === '0') {
                        log(`æ•°æ®æ¡æ•°: ${response.data.data?.length || 0}`, 'info');
                    }
                    
                } catch (error) {
                    log(`âŒ ${apiPath} - å¤±è´¥: ${error.message}`, 'error');
                }
                
                // æ·»åŠ å»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        // 3. æµ‹è¯•å¤„æ–¹æ¥å£è·¯å¾„
        async function testPrescriptionPaths() {
            clearResults();
            log('æµ‹è¯•å¤„æ–¹æ¥å£è·¯å¾„...', 'info');
            
            for (const path of prescriptionPaths) {
                try {
                    log(`æµ‹è¯•è·¯å¾„: ${path}`, 'info');
                    
                    const formData = new FormData();
                    formData.append('page', '1');
                    formData.append('limit', '5');
                    formData.append('patienttype', 'mypatient');
                    formData.append('queryselect', '');
                    formData.append('querycontent', '');
                    formData.append('hospitalsel', '0');
                    formData.append('patientlaydate', '');
                    formData.append('automation', '-2');
                    formData.append('printstate', '');
                    formData.append('logisticstime', '');
                    formData.append('decmothed', '0');
                    formData.append('packagenum', '0');
                    formData.append('ptype', '0');
                    formData.append('pstate', '0');
                    formData.append('processtype', '0');
                    formData.append('isrepetition', '1');
                    formData.append('addtype', '-1');
                    
                    const response = await axios.post(path, formData, {
                        headers: {
                            'Accept': 'application/json, text/javascript, */*; q=0.01',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                        },
                        timeout: 15000
                    });
                    
                    log(`âœ… ${path} - æˆåŠŸå“åº”!`, 'success');
                    log(`çŠ¶æ€ç : ${response.status}`, 'success');
                    log(`å“åº”ä»£ç : ${response.data?.code}`, 'info');
                    log(`æ•°æ®æ¡æ•°: ${response.data?.data?.length || 0}`, 'info');
                    log(`æ€»è®°å½•æ•°: ${response.data?.count || 'N/A'}`, 'info');
                    
                    if (response.data && response.data.code === '0') {
                        log(`ğŸ‰ æ‰¾åˆ°æ­£ç¡®çš„å¤„æ–¹æ¥å£: ${path}`, 'success');
                    }
                    
                } catch (error) {
                    log(`âŒ ${path} - ${error.response?.status || 'Network Error'}: ${error.message}`, 'error');
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        // 4. æµ‹è¯•ç›´è¿æœåŠ¡å™¨
        async function testDirectConnection() {
            clearResults();
            log('æµ‹è¯•ç›´è¿æœåŠ¡å™¨...', 'info');
            
            try {
                // å°è¯•ç›´æ¥è¿æ¥ä»£ç†ç›®æ ‡æœåŠ¡å™¨
                                 const directUrl = 'http://192.168.80.79:8000/PreScription/GetExpressTypeDataByCache';
                log(`å°è¯•ç›´è¿: ${directUrl}`, 'info');
                
                const response = await axios.post(directUrl, '', {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        'Accept': 'application/json, text/javascript, */*; q=0.01',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    timeout: 15000
                });
                
                log('âœ… ç›´è¿æœåŠ¡å™¨æˆåŠŸï¼', 'success');
                log(`å“åº”çŠ¶æ€: ${response.status}`, 'success');
                log('è¿™è¯´æ˜ç›®æ ‡æœåŠ¡å™¨æ˜¯å¯è®¿é—®çš„ï¼Œé—®é¢˜åœ¨äºä»£ç†é…ç½®', 'warning');
                
            } catch (error) {
                log(`âŒ ç›´è¿æœåŠ¡å™¨å¤±è´¥: ${error.message}`, 'error');
                
                if (error.code === 'ERR_NETWORK' || error.message.includes('Network Error')) {
                                         log('âš ï¸ æœåŠ¡å™¨192.168.80.79:8000ä¸å¯è®¿é—®', 'warning');
                    log('å¯èƒ½çš„åŸå› ï¼š', 'info');
                    log('1. æœåŠ¡å™¨æœªå¯åŠ¨', 'info');
                    log('2. ç½‘ç»œä¸é€š', 'info');
                    log('3. é˜²ç«å¢™é˜»æ­¢', 'info');
                                         log('4. ç«¯å£8000æœªå¼€æ”¾', 'info');
                } else {
                    log(`å…¶ä»–é”™è¯¯: ${error.response?.status} - ${error.response?.statusText}`, 'error');
                }
            }
        }

        // è¿è¡Œå…¨éƒ¨æµ‹è¯•
        async function runAllTests() {
            clearResults();
            log('ğŸš€ å¼€å§‹è¿è¡Œå…¨éƒ¨æµ‹è¯•...', 'info');
            log('', 'info');
            
            log('=== 1. æµ‹è¯•ä»£ç†è¿æ¥ ===', 'info');
            const proxyWorking = await testProxyConnection();
            log('', 'info');
            
            if (proxyWorking) {
                log('=== 2. æµ‹è¯•å·²çŸ¥å¯ç”¨æ¥å£ ===', 'info');
                await testKnownWorkingAPI();
                log('', 'info');
                
                log('=== 3. æµ‹è¯•å¤„æ–¹æ¥å£è·¯å¾„ ===', 'info');
                await testPrescriptionPaths();
                log('', 'info');
            } else {
                log('=== ä»£ç†ä¸å¯ç”¨ï¼Œæµ‹è¯•ç›´è¿æœåŠ¡å™¨ ===', 'warning');
                await testDirectConnection();
                log('', 'info');
            }
            
            log('=== æµ‹è¯•å®Œæˆ ===', 'success');
            log('è¯·æ ¹æ®ä¸Šè¿°ç»“æœè°ƒæ•´é…ç½®', 'info');
        }
    </script>
</body>
</html> 